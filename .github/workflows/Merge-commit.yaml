name: Actualizar Componentes
run-name: Push hecho por parte de ${{ github.actor }}

on: 
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
      contents: write  
      pull-requests: write

jobs:
  actualizar-deploy:
    runs-on: ubuntu-latest
    steps:

      - name: Clonar repositorio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_TOKEN  }}
      - name: Conseguir los nombres de los .json
        id: lista-json
        run: |
          all_archivos=$(find . -type f -name "*.json" | sed 's/\.json$//')

           echo "archivos<<EOF" >> $GITHUB_OUTPUT
           echo "$all_archivos" >> $GITHUB_OUTPUT
           echo "EOF" >> $GITHUB_OUTPUT

      - name: Actualizar los nuevos componentes
        run: |
             # Variables de entrada
             componentes="${{ steps.lista-json.outputs.archivos }}"
             options=$(echo "$componentes" | sed 's/^/                          - /')
         
             echo "Componentes a insertar: $options"
         
             awk -v new_options="$options" '
             /component:/ { print; in_block=1; next }

             /options:/ && in_block {
               print
               print new_options
               skip=1
               next
             }

             in_block && skip {
               if (/^[[:space:]]*-/) next
               else { in_block=0; skip=0 }
             }

             { print }
             ' .github/workflows/Deploy.yml > temp && mv temp .github/workflows/Deploy.yml
         

             cat .github/workflows/Deploy.yml

      - name: Crear Pull Request en el repositorio oficial usando create-pull-request
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.MY_TOKEN }}
          title: "Actualización de opciones de componentes en Deploy.yml"
          body: "Este Pull Request actualiza las opciones de componentes en Deploy.yml."
          base: "main"
          commit-message: "Actualización automática de opciones de componentes"
          branch: "feature/change-inputs-components"